$(function(){
	//给菜单项加上默认data-index序号，如果有则不加；用来给iframe命名
	$(".J_menuItem").each(function(k){
		if(!$(this).attr("data-index")){
			$(this).attr("data-index",k);
		}
	});
	
	// 点击菜单项，tab上显示标签，iframe，加载href内容
	$(".J_menuItem").on("click",c);
	function c(){
		var o=$(this).attr("href"),
			m=$(this).data("index"),
			l=$.trim($(this).text()),			
			k=true;	
			
		// 如href无内容，返回false
		if(o==undefined||$.trim(o).length==0){			
			return false;
		}		
		// 遍历tab,如果已经打开则不再打开
		$(".J_menuTab").each(function(){
			if($(this).data("id")==o){//如id=href的内容
				if(!$(this).hasClass("active")){
					$(this).addClass("active").siblings(".J_menuTab").removeClass("active");//设置当前标签为active，其他删除active
					g(this);//并不影响选项卡效果
					$(".J_mainContent .J_iframe").each(function(){//从已经加载过的页面获取iframe，不是向服务器再请求
						if($(this).data("id")==o){//从这可看出每次创建是将href赋给了id来做查找
							$(this).show().siblings(".J_iframe").hide();
							return false;
						}
					});
				}
				k=false;
				return false;
			}
		});
		//如果J_mainContent中没有，内容未加载过
		if(k){			
			var p='<a href="javascript:;" class="active J_menuTab" data-id="'+o+'">'+l+' <i class="fa fa-times-circle"></i></a>';
			$(".J_menuTab").removeClass("active");//去除选项卡的全部效果
			var n='<iframe class="J_iframe" name="iframe'+m+'" width="100%" height="100%" src="'+o+'" frameborder="0" data-id="'+o+'" seamless></iframe>';
			// 追加元素
			$(".J_mainContent").find("iframe.J_iframe").hide().parents(".J_mainContent").append(n);
			$(".J_menuTabs .page-tabs-content").append(p);
			g($(".J_menuTab.active"));
		}
		return false;
	}	

	// 单击选项卡上(点击的是小×号，在a下面)
	$(".J_menuTabs").on("click",".J_menuTab i",h);
	function h(){
		var m=$(this).parents(".J_menuTab").data("id");//相当获取href
		var l=$(this).parents(".J_menuTab").width();
		//如点击的具有active属性
		if($(this).parents(".J_menuTab").hasClass("active")){
			//判断当前元素后面紧邻是否有选项卡(如果有)
			if($(this).parents(".J_menuTab").next(".J_menuTab").size()){				
				var k=$(this).parents(".J_menuTab").next(".J_menuTab:eq(0)").data("id");//获取后一个选项卡href，即id				
				$(this).parents(".J_menuTab").next(".J_menuTab:eq(0)").addClass("active");//为后一个增加active属性
				$(".J_mainContent .J_iframe").each(function(){//显示后一个选项卡内容
					if($(this).data("id")==k){
						$(this).show().siblings(".J_iframe").hide();
						return false;
					}
				});
				var n=parseInt($(".page-tabs-content").css("margin-left"));				
				if(n<0){//不太理解，应是处理左侧有margin的情况
					$(".page-tabs-content").animate({marginLeft:(n+l)+"px"},"fast");
				}
				$(this).parents(".J_menuTab").remove();
				$(".J_mainContent .J_iframe").each(function(){//删除当前iframe内容
					if($(this).data("id")==m){
						$(this).remove();
						return false;
					}
				});
			}
			//判断当前元素前面紧邻是否有选项卡(如果点的是最后一个元素)
			if($(this).parents(".J_menuTab").prev(".J_menuTab").size()){				
				var k=$(this).parents(".J_menuTab").prev(".J_menuTab:last").data("id");
				$(this).parents(".J_menuTab").prev(".J_menuTab:last").addClass("active");
				$(".J_mainContent .J_iframe").each(function(){
					if($(this).data("id")==k){
						$(this).show().siblings(".J_iframe").hide();
						return false;
					}
				});
				$(this).parents(".J_menuTab").remove();
				$(".J_mainContent .J_iframe").each(function(){
					if($(this).data("id")==m){
						$(this).remove();
						return false;
					}
				});
			}
		}
		else{
			$(this).parents(".J_menuTab").remove();
			$(".J_mainContent .J_iframe").each(function(){
				if($(this).data("id")==m){
					$(this).remove();
					return false;
				}
			});
			g($(".J_menuTab.active"));//获取menuTab中点击的
		}
		return false;
	}
	//控制动画效果 ？？
	function g(n){
		// 获取当前元件之前和之后的同辈元件（宽度总和）
		var o=f($(n).prevAll()),q=f($(n).nextAll());
		var l=f($(".content-tabs").children().not(".J_menuTabs"));//获取除menuTabs长度
		var k=$(".content-tabs").outerWidth(true)-l;
		var p=0;
		if($(".page-tabs-content").outerWidth()<k){
			p=0;
		}
		else{
			if(q<=(k-$(n).outerWidth(true)-$(n).next().outerWidth(true))){
				if((k-$(n).next().outerWidth(true))>q){
					p=o;
					var m=n;
					while((p-$(m).outerWidth())>($(".page-tabs-content").outerWidth()-k)){
						p-=$(m).prev().outerWidth();
						m=$(m).prev();
					}
				}
			}
			else{
				if(o>(k-$(n).outerWidth(true)-$(n).prev().outerWidth(true))){
					p=o-$(n).prev().outerWidth(true);
				}
			}
		}
		$(".page-tabs-content").animate({marginLeft:0-p+"px"},"fast");
	}
	//获取元素外部宽度（默认包括补白和边框）总和
	function f(l){
		var k=0;
		$(l).each(function(){
			k+=$(this).outerWidth(true);});//获取匹配元素外部宽度（默认包括补白和边框）
		return k;
	}
	
	// 点击向左箭头
	$(".J_tabLeft").on("click",a);
	//向左移动
	function a(){
		var o=Math.abs(parseInt($(".page-tabs-content").css("margin-left")));//点击了向右，margin-left会为负数
		var l=f($(".content-tabs").children().not(".J_menuTabs"));
		var k=$(".content-tabs").outerWidth(true)-l;//整个选项卡长度
		var p=0;
		if($(".page-tabs-content").width()<k){
			return false;
		}
		else{
			var m=$(".J_menuTab:first");
			var n=0;
			while((n+$(m).outerWidth(true))<=o){
				n+=$(m).outerWidth(true);
				m=$(m).next();
			}
			n=0;
			if(f($(m).prevAll())>k){
				while((n+$(m).outerWidth(true))<(k)&&m.length>0){
					n+=$(m).outerWidth(true);
					m=$(m).prev();
			}
			p=f($(m).prevAll());
		}
		}
		$(".page-tabs-content").animate({marginLeft:0-p+"px"},"fast");
	}
	// 点击向右箭头
	$(".J_tabRight").on("click",b);
	function b(){
		var o=Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
		var l=f($(".content-tabs").children().not(".J_menuTabs"));
		var k=$(".content-tabs").outerWidth(true)-l;
		var p=0;
		if($(".page-tabs-content").width()<k){
			return false;
		}
		else{
			var m=$(".J_menuTab:first");
			var n=0;
			while((n+$(m).outerWidth(true))<=o){
				n+=$(m).outerWidth(true);
				m=$(m).next();
			}
			n=0;
			while((n+$(m).outerWidth(true))<(k)&&m.length>0){
				n+=$(m).outerWidth(true);
				m=$(m).next();
			}
			p=f($(m).prevAll());
			if(p>0){
				$(".page-tabs-content").animate({marginLeft:0-p+"px"},"fast");
			}
		}
	}
	
	// 点击无active，转换选项卡
	$(".J_menuTabs").on("click",".J_menuTab",e);
	function e(){
		if(!$(this).hasClass("active")){//如没有active
			var k=$(this).data("id");
			$(".J_mainContent .J_iframe").each(function(){
				if($(this).data("id")==k){
					$(this).show().siblings(".J_iframe").hide();
					return false;
				}
			});
			$(this).addClass("active").siblings(".J_menuTab").removeClass("active");
			g(this);//？？
		}
	}	

	// 双击具体选项卡,其中k为href，无实际效果
	$(".J_menuTabs").on("dblclick",".J_menuTab",d);
	function d(){
		var l=$('.J_iframe[data-id="'+$(this).data("id")+'"]');		
		var k=l.attr("src");		
	}

	// 关闭其他，关闭不是active的
	$(".J_tabCloseOther").on("click",i);
	function i(){
		$(".page-tabs-content").children("[data-id]").not(":first").not(".active").each(function(){
			$('.J_iframe[data-id="'+$(this).data("id")+'"]').remove();
			$(this).remove();
		});
		$(".page-tabs-content").css("margin-left","0");
	}
	// 定位当前选项卡，不知何用
	$(".J_tabShowActive").on("click",j);
	function j(){
		g($(".J_menuTab.active"));
	}
	// 点击全部关闭
	$(".J_tabCloseAll").on("click",function(){
		// 遍历有data-id，但不是首个元素
		$(".page-tabs-content").children("[data-id]").not(":first").each(function(){
			$('.J_iframe[data-id="'+$(this).data("id")+'"]').remove();
			$(this).remove();
		});
		$(".page-tabs-content").children("[data-id]:first").each(function(){//设置首页内容
			$('.J_iframe[data-id="'+$(this).data("id")+'"]').show();
			$(this).addClass("active");
		});
		$(".page-tabs-content").css("margin-left","0");
	});
});
